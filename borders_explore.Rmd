---
title: "R Notebook"
output: html_notebook
---

**Please prepare a 1 to 2 page analysis summary answering the question below.**

**In order to help inform the planning for provision of cancer treatment services in NHS Borders, we would like to gain better understanding of the incidence of cancer in NHS Borders.**

**You will present your findings back to us during the Mock Interviews. Presentations will be 5 minutes long**


**Remember** "A better understanding of the incidence of cancer in NHS Borders"

1. Find the definition of incidence in the documentation provided:

"Incidence is the total number of new cases (registrations) of the cancer diagnosed in Scotland for the given period."

2. Next, which insights could be *actionable*. Focus on these. 

The question refers to the helping "inform the planning for *provision* of cancer service in NHS Borders". This should be the focus for insights that are actionable:

Geographic considerations should be taken into account. Where are the higher incidents of certain types of treatment. 

Where are current cancer treatment services available

How can services be improved for those suffering from cancer in the area, given the number of incidence. 

```{r}
library(tidyverse)
library(janitor)

health_board_data <- read_csv("data/opendata_inc9418_hb.csv") %>% clean_names()
scotland_data <- read_csv("data/opendata_inc9418_scotland.csv") %>% clean_names()
regional_data <- read_csv("data/opendata_inc9418_region.csv") %>%  clean_names()
hb_codes <- read_csv("data/geography_codes_and_labels_hb2014_01042019.csv") %>% clean_names()
```

Let's take a look at the number of these columns and work out how many we have and how they should be organised from here.

```{r}
health_board_data %>% 
  colnames()
```

OK, so what becomes immedietely apparent is that the data doesn't seem to be broken down into age group. Instead, we are only given an incidences_all_ages column, along with wath is described as a "crude rate". For a task in this timeframe, with one person non-technical interviewing and with five minutes to talk about, I don't think it would be useful to go to deeply into the confidence intervals at this stage. If we are struggling for useful (i.e. *actionable*) insights, then using some of these 95 confidence intervals could be good as a last resort. 

What we do have is a breakdown of different types of cancer, and a breakdown in terms of the sexes. We should be able to get some insights here, but what conclusions could be drawn linking back to the "planning for provision of cancer treatment services in NHS Borders". We might have to compare rates to that of surrounding health boards, the overall region and Scotland as a whole. Think it might be best to just play about with this first lot of data tonight though and see if there are any striking figures in terms of types of cancer over the years. 

```{r}
borders_data <-
health_board_data %>% 
  filter(hb == "S08000016")
```

So once we extract just the NHS borders data, what we find are left with is 3400 observations. Now let's see how many cancer types we're dealing with:

```{r}
borders_data %>% 
  distinct(cancer_site)
```

So we have 52 cancer sites/types, including an "All cancer types" label. 

```{r}
borders_data %>% 
  distinct(sex_qf)
```

According to the accompanying documentation, "Confidence intervals for age-standardised rates (EASR and WASR) have been calculated using a formula which works only when numbers are sufficiently large. They are therefore set to 'not applicable' in the event of there being fewer than 20 cases."

```{r}
borders_data %>% 
  summarise(across(.fns = ~sum(is.na(.x))))
```

So there don't seem to be any observations that are relvant to our early analysis that are NAs. There do seem to be a number of NAs in the "sex_qf" column which I'm still a little confused on, the alternative simply being "d". The NAs referenced above can also be seen. 

Let's just see if we can begin by plotting the differnt types of cancer and their prevalence by both number an rate.

```{r}
borders_data %>% 
filter(cancer_site != "All cancer types",
       sex == "All") %>%
ggplot() +
  aes(x = year, y = incidences_all_ages, color = cancer_site) +
  geom_line() +
  theme(legend.position = "none")
```

```{r}

```

```{r}
#I mean, we could take this as the first graph and compare this with population growth in the area. Although to be honest, we'd be better off just looking at the rate. 
borders_data %>% 
filter(cancer_site == "All cancer types",
       sex == "All") %>%
ggplot() +
  aes(x = year, y = incidences_all_ages, color = cancer_site) +
  geom_line() +
  theme(legend.position = "none")
```

```{r}
borders_data %>% 
filter(cancer_site == "All cancer types",
       sex == "All") %>%
ggplot() +
  geom_line(aes(x = year, y = incidences_all_ages), colour = "blue") +
  geom_point(aes(x = year, y = crude_rate), colour = "red") +
  geom_line (aes(x = year, y = crude_rate), colour = "red")
```

```{r}
# borders_data %>% 
#  mutate(total_incidences = )
```

```{r}
borders_data %>%
  distinct(year)
```

Right, the above idea can be left for later. For now, I want to replicate three graphs that have been provided for the overall Scottish context. These graphs are contained in the Cancer Incidence in Scotland (2016) report. Here is the plan (refer back to the document for visual reference):


1. Cancer incidence in Scotland, 1992-2016. Number of cases and age-adjusted
incidence rate by sex.

```{r}
#These graphs can be easily changed later on to accommodate other rates, especially when we look a bit further into the easr and wasr rates.
borders_data %>%
  filter(cancer_site == "All cancer types",
         sex != "All") %>%
ggplot() +
  aes(x = year, y = incidences_all_ages, colour = sex) +
  geom_line(linetype = "dashed") +
  geom_line(aes(x = year, y = crude_rate)) +
  scale_x_continuous(breaks = seq(1994, 2018, by = 2 )) +
  scale_y_continuous(sec.axis = sec_axis(~./8, name = "Crude Rate\n")) +
  labs(x = "Year",
       y = "Incidences",
       title = "Cancer incidence in NHS Borders",
       subtitle = "Number of New Cases Per Year and Crude Rate") +
  #Can't work out why the legend below isn't working
  scale_fill_discrete(name = "Sex", labels = c("a", "b")) +
  theme_minimal()
```

```{r}
#Will need to understand and be able to explain how the geom_smooth is working in this particular case.
borders_data %>%
  filter(cancer_site == "All cancer types",
         sex != "All") %>%
ggplot() +
  aes(x = year, y = incidences_all_ages, colour = sex) +
  geom_smooth(linetype = "dashed") +
  geom_smooth(aes(x = year, y = crude_rate)) +
  scale_x_continuous(breaks = seq(1994, 2018, by = 2 )) +
  scale_y_continuous(sec.axis = sec_axis(~./8, name = "Crude Rate\n")) +
  labs(x = "Year",
       y = "Incidences",
       title = "Cancer incidence in NHS Borders",
       subtitle = "Number of New Cases Per Year and Crude Rate") +
  #Can't work out why the legend below isn't working
  scale_fill_discrete(name = "Sex", labels = c("a", "b")) +
  theme_minimal()
```

2. Figure 4. Most common 20 cancers in Scotland in 2016 for females and males (ordered by total for all persons)

```{r}
#Could have worked out a different way to arrange by total and then mutated this into a new column rather than combining the male and female figures afterwards. 
chart_2_borders_data <-
borders_data %>% 
  filter(year == 2016,
         sex != "All",
         cancer_site != "All cancer types"
        ) %>% 
  mutate(name_and_code = str_c(cancer_site, " (", cancer_site_icd10code, ")")) %>%
  mutate(name_and_code = str_remove(name_and_code, "ICD-10 "))


chart_2_borders_data
```

```{r}
#Think this is right but can always check when we make the graph
chart_2_border_scot_top_20 <-
chart_2_borders_data %>%
  filter(cancer_site %in% c("Trachea, bronchus and lung",
                            "Breast",
                            "Colorectal cancer",
                            "Prostate",
                            "Malignant melanoma of the skin",
                            "Head and neck",
                            "Non-Hodgkin lymphoma",
                            "Kidney",
                            "Bladder",
                            "Oesophagus", 
                            "Pancreas",
                            "Corpus uteri",
                            "Stomach",
                            "Leukaemias", 
                            "Ovary",
                            "Liver and intrahepatic bile ducts", 
                            "Multiple myeloma and malignant plasma cell neoplasms",
                            "Brain and other CNS",
                            "Cervix uteri",
                            "Thyroid")) %>% 
  
  mutate(cancer_site = factor(cancer_site, levels = c("Trachea, bronchus and lung",
                            "Breast",
                            "Colorectal cancer",
                            "Prostate",
                            "Malignant melanoma of the skin",
                            "Head and neck",
                            "Non-Hodgkin lymphoma",
                            "Kidney",
                            "Bladder",
                            "Oesophagus", 
                            "Pancreas",
                            "Corpus uteri",
                            "Stomach",
                            "Leukaemias", 
                            "Ovary",
                            "Liver and intrahepatic bile ducts", 
                            "Multiple myeloma and malignant plasma cell neoplasms",
                            "Brain and other CNS",
                            "Cervix uteri",
                            "Thyroid")))


chart_2_border_scot_top_20  
  
```

```{r}
#Need to find a way to flip the female and male dodges. Also, should rename a couple of the cancer_sites
chart_2_border_scot_top_20 %>% 
  ggplot() +
  aes(x = incidences_all_ages, 
      y = reorder(cancer_site, 
                  desc(cancer_site)), 
                  fill = sex) +
  geom_col(position = "dodge") +
  labs(y = "") +
  theme(axis.text.y = element_text(size = 8))


 
```

```{r}
  ggplot() +
  geom_col(aes(x = start_month, y = total_bike_hires)) +
  coord_flip() +
  geom_point(aes(x = start_month, y = avg_monthly_temp*8), colour = "blue") +
  geom_line(aes(x = start_month, y = avg_monthly_temp*8), group = 1, colour = "blue") +
  scale_y_continuous(name = "Total Bike Hires\n", 
                     sec.axis = sec_axis(~./8, name = "Average Temperatures °F (Central Park)\n")) +
  labs(x = "Start Month",
       title = "Bike Hires vs Temperature (2018)\n") +
  theme(
    axis.title.x = element_text(color = "blue"),
    axis.title.x.bottom = element_text(color = "black")
  ) +
  theme_minimal()
```

3. Figure 5. 10 year percentage change in incidence rate for 20 most common cancers in Scotland

